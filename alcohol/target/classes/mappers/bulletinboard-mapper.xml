<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.mid.alcohol.repository.BulletinboardRepository">
    
    <!-- 전체 게시글 보기 -->
    <select id="selectImageOrderByIdDesc" resultType="com.mid.alcohol.dto.BulletinboardListDto">
        select IMAGE, BOARD_ID from BULLETINBOARD order by BOARD_ID desc
    </select>
    
    <!-- 이미지를 제외한 전체 게시글 보기 -->
     <select id="selectNotImageOrderByIdDesc" resultType="com.mid.alcohol.dto.BulletinboardListDto">
        select B.BOARD_ID, B.TITLE, B.NICKNAME, B.USER_ID, B.TIME, B.VIEWS, B.RECOMMEND, B.CONTENT, B.CATEGORY, count(C.COMMENT_ID) as RCNT
        from BULLETINBOARD B left join COMMENTS C
            on B.BOARD_ID = C.BOARD_ID
        group by B.BOARD_ID, B.TITLE, B.NICKNAME, B.USER_ID, B.TIME, B.VIEWS, B.RECOMMEND, B.CONTENT, B.CATEGORY
        order by B.BOARD_ID desc
	</select>
    
    <!-- 글 작성 -->
    <insert id="bulletinboardInsert">
        insert into BULLETINBOARD (CATEGORY, TITLE, IMAGE, NICKNAME, USER_ID, CONTENT)
        values (#{category}, #{title}, #{image}, #{nickname}, #{user_id}, #{content})
    </insert>
    
    <!-- 게시글 상세보기 -->
    <select id="selectById" resultType="com.mid.alcohol.dto.BulletinboardDetailDto">
        select * from BULLETINBOARD where BOARD_ID = #{boardId}
    </select>
    
    <!-- 글 삭제하기(delete) -->
    <delete id="bulletinboardDeleteById">
        delete from BULLETINBOARD where BOARD_ID = #{board_id}
    </delete>
    
    <!-- 게시글 수정하기(업데이트) -->
    <update id="bulletinboardUpdateById">
        update BULLETINBOARD
        set TITLE= #{title}, IMAGE= #{image}, CONTENT= #{content}, TIME= systimestamp
        where BOARD_ID= #{board_id}
    </update>
    
    <!-- 이미지가 null일때 업데이트 -->
    <update id="bulletinboardUpdateByIdImageNull">
        update BULLETINBOARD
        set TITLE= #{title}, CONTENT= #{content}, TIME= systimestamp
        where BOARD_ID= #{board_id}
    </update>
    
    <!-- 검색하기 (title, content, title and content, nickname, user_id) -->
    
    <!-- 글 제목으로 검색하기 -->
    <select id="selectImageWhereTitle" resultType="com.mid.alcohol.dto.BulletinboardListDto">
        select IMAGE from BULLETINBOARD where lower(TITLE) like lower('%' || #{keyword} || '%') order by BOARD_ID desc
    </select>
    
    <select id="selectWhereTitle" resultType="com.mid.alcohol.dto.BulletinboardListDto">
        select B.BOARD_ID, B.TITLE, B.NICKNAME, B.USER_ID, B.TIME, B.VIEWS, B.RECOMMEND, B.CONTENT, B.CATEGORY, count(C.COMMENT_ID) as RCNT
        from BULLETINBOARD B left join COMMENTS C
            on B.BOARD_ID = C.BOARD_ID
        where lower(B.TITLE) like lower('%' || #{keyword} || '%')
        group by B.BOARD_ID, B.TITLE, B.NICKNAME, B.USER_ID, B.TIME, B.VIEWS, B.RECOMMEND, B.CONTENT, B.CATEGORY
        order by B.BOARD_ID desc
	</select>
    
    <!-- 글 내용으로 검색하기 -->
    <select id="selectImageWhereContent" resultType="com.mid.alcohol.dto.BulletinboardListDto">
        select IMAGE from BULLETINBOARD where lower(CONTENT) like lower('%' || #{keyword} || '%') order by BOARD_ID desc
    </select>
    
    <select id="selectWhereContent" resultType="com.mid.alcohol.dto.BulletinboardListDto">
        select B.BOARD_ID, B.TITLE, B.NICKNAME, B.USER_ID, B.TIME, B.VIEWS, B.RECOMMEND, B.CONTENT, B.CATEGORY, count(C.COMMENT_ID) as RCNT
        from BULLETINBOARD B left join COMMENTS C
            on B.BOARD_ID = C.BOARD_ID
        where lower(B.CONTENT) like lower('%' || #{keyword} || '%')
        group by B.BOARD_ID, B.TITLE, B.NICKNAME, B.USER_ID, B.TIME, B.VIEWS, B.RECOMMEND, B.CONTENT, B.CATEGORY
        order by B.BOARD_ID desc
	</select>
    
    <!-- 제목과 내용으로 검색하기 -->
    <select id="selectImageWhereTitleAndContent" resultType="com.mid.alcohol.dto.BulletinboardListDto">
        select IMAGE from BULLETINBOARD 
        where lower(B.TITLE) like lower('%' || #{keywordT} || '%') or lower(B.CONTENT) like lower('%' || #{keywordC} || '%') 
        order by BOARD_ID desc
    </select>
    
    <select id="selectWhereTitleAndContent" resultType="com.mid.alcohol.dto.BulletinboardListDto">
        select B.BOARD_ID, B.TITLE, B.NICKNAME, B.USER_ID, B.TIME, B.VIEWS, B.RECOMMEND, B.CONTENT, B.CATEGORY, count(C.COMMENT_ID) as RCNT
        from BULLETINBOARD B left join COMMENTS C
            on B.BOARD_ID = C.BOARD_ID
        where lower(B.TITLE) like lower('%' || #{keywordT} || '%') or lower(B.CONTENT) like lower('%' || #{keywordC} || '%')
        group by B.BOARD_ID, B.TITLE, B.NICKNAME, B.USER_ID, B.TIME, B.VIEWS, B.RECOMMEND, B.CONTENT, B.CATEGORY
        order by B.BOARD_ID desc
	</select>
    
    <!-- 닉네임으로 검색하기 -->
    <select id="selectImageWhereNickname" resultType="com.mid.alcohol.dto.BulletinboardListDto">
        select IMAGE from BULLETINBOARD where lower(NICKNAME) like lower('%' || #{keyword} || '%') order by BOARD_ID desc
    </select>
    
    <select id="selectWhereNickname" resultType="com.mid.alcohol.dto.BulletinboardListDto">
        select B.BOARD_ID, B.TITLE, B.NICKNAME, B.USER_ID, B.TIME, B.VIEWS, B.RECOMMEND, B.CONTENT, B.CATEGORY, count(C.COMMENT_ID) as RCNT
        from BULLETINBOARD B left join COMMENTS C
            on B.BOARD_ID = C.BOARD_ID
        where lower(B.NICKNAME) like lower('%' || #{keyword} || '%')    
        group by B.BOARD_ID, B.TITLE, B.NICKNAME, B.USER_ID, B.TIME, B.VIEWS, B.RECOMMEND, B.CONTENT, B.CATEGORY
        order by B.BOARD_ID desc
	</select>
    
    <!-- 유저 아이디로 검색하기 -->
    <select id="selectImageWhereUserId" resultType="com.mid.alcohol.dto.BulletinboardListDto">
        select IMAGE from BULLETINBOARD where lower(USER_ID) like lower('%' || #{keyword} || '%') order by BOARD_ID desc
    </select>
    
    <select id="selectWhereUserId" resultType="com.mid.alcohol.dto.BulletinboardListDto">
        select B.BOARD_ID, B.TITLE, B.NICKNAME, B.USER_ID, B.TIME, B.VIEWS, B.RECOMMEND, B.CONTENT, B.CATEGORY, count(C.COMMENT_ID) as RCNT
        from BULLETINBOARD B left join COMMENTS C
            on B.BOARD_ID = C.BOARD_ID
        where lower(B.USER_ID) like lower('%' || #{keyword} || '%')
        group by B.BOARD_ID, B.TITLE, B.NICKNAME, B.USER_ID, B.TIME, B.VIEWS, B.RECOMMEND, B.CONTENT, B.CATEGORY
        order by B.BOARD_ID desc
	</select>
    
    <!-- 추천업 버튼 -->
    <update id="recommendUp">
    	update BULLETINBOARD
        set RECOMMEND = RECOMMEND + 1
        where BOARD_ID= #{boardId}
    </update>
    
    <!-- 추천업하면 COMMENDUP테이블 정보 생성 -->
    <insert id="commendupInsert">
    	insert into COMMENDUP (BOARD_ID, RECOMMENDER_ID)
        values (#{boardId}, #{recommenderId})
    </insert>
    
    <!-- 추천업 중복확인을 위한 리스트 읽기 -->
    <select id="recommendUpSelect" resultType="com.mid.alcohol.domain.RecommendUp">
    	select * from COMMENDUP where BOARD_ID = #{boardId} and RECOMMENDER_ID = #{recommenderId}
    </select>
    
    <!-- 추천다운 버튼 -->
    <update id="recommendDo">
    	update BULLETINBOARD
        set RECOMMEND = RECOMMEND - 1
        where BOARD_ID= #{boardId}
    </update>
    
    <!-- 추천다운하면 COMMENDDOWN테이블 정보 생성 -->
    <insert id="commenddownInsert">
    	insert into COMMENDDOWN (BOARD_ID, RECOMMENDER_ID)
        values (#{boardId}, #{recommenderId})
    </insert>
    
    <!-- 추천다운 중복확인을 위한 리스트 읽기 -->
    <select id="recommendDownSelect" resultType="com.mid.alcohol.domain.RecommendDown">
    	select * from COMMENDDOWN where BOARD_ID = #{boardId} and RECOMMENDER_ID = #{recommenderId}
    </select>
    
    <!-- 조회수 기능 -->
    <update id="viewsUp">
    	update BULLETINBOARD
        set VIEWS = VIEWS + 1
        where BOARD_ID= #{boardId}
    </update>
    
    <!-- 게시판 공지 사항만 보는 기능 -->
    <select id="selectAnnouncement" resultType="com.mid.alcohol.domain.Bulletinboard">
    	select * from BULLETINBOARD where CATEGORY = 1 order by BOARD_ID desc
    </select>
    
    <!-- 게시판 추천 높은순으로 나열하는 기능 -->
    <select id="selectOrderByRecommend" resultType="com.mid.alcohol.domain.Bulletinboard">
    	select * from BULLETINBOARD order by RECOMMEND desc
    </select>
    
    
    
    
</mapper>